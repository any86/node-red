<script type="text/html" data-template-name="zb-http-in">
    <zb-http-in id="zb-http-in"></zb-http-in>
</script>

<script type="text/javascript">
    (function () {
        let formData = {}; // 用 let 方便重置
        let originalConfig = {}; // 用于备份原始配置

        function onChange(e) {
            // 实时更新 formData
            Object.assign(formData, { ...e.target.value });
        }

        const DEFAULTS = {
            name: { value: "请求开始" },
            url: {
                value: "", required: true,
                label: RED._("node-red:httpin.label.url")
            },
            method: { value: "get", required: true },
            upload: { value: false },
            skipBodyParsing: { value: false }
        };

        RED.nodes.registerType('zb-http-in', {
            category: '坐标软件',
            color: "rgb(1, 255, 174)",
            defaults: DEFAULTS,
            inputs: 0,
            outputs: 1,
            icon: "zb-http-in.jpg",
            paletteLabel: '请求开始',
            label: function () {
                if (this.name) {
                    return this.name;
                } else if (this.url) {
                    var root = RED.settings.httpNodeRoot;
                    if (root.slice(-1) != "/") {
                        root = root + "/";
                    }
                    if (this.url.charAt(0) == "/") {
                        root += this.url.slice(1);
                    } else {
                        root += this.url;
                    }
                    return "[" + this.method + "] " + root;
                } else {
                    return "http";
                }
            },
            labelStyle: function () {
                return this.name ? "node_label_italic" : "";
            },

            oneditsave() {
                // 1. 修复变量声明顺序：先声明后使用
                const node = this;

                // 2. 将 formData 同步到节点实例
                if (formData.url !== undefined) node.url = formData.url;
                if (formData.method !== undefined) node.method = formData.method;
                if (formData.name !== undefined) node.name = formData.name;
                if (formData.upload !== undefined) node.upload = formData.upload;
                if (formData.skipBodyParsing !== undefined) node.skipBodyParsing = formData.skipBodyParsing;
                console.log("当前节点配置：", node);

                alert('保存成功');
                // 清空 formData，避免下次编辑污染
                formData = {};
            },

            oneditvalidate() {
                console.log("执行验证逻辑");
                // 3. 示例：验证 url 不为空（配合 defaults 中的 required: true）
                if (!formData.url && !this.url) { // 若 formData 未修改，用原始值验证
                    alert("URL 不能为空");
                    return false; // 阻止保存
                }
                return true; // 验证通过，允许执行 oneditsave
            },

            oneditcancel() {
                alert('已取消编辑');
                // 4. 恢复原始配置：清空 formData，组件回显原始值
                formData = {};
                const zbHttpInComponent = document.getElementById("zb-http-in");
                zbHttpInComponent.value = originalConfig; // 回显备份的原始数据
            },

            oneditprepare: function () {
                const node = this;
                console.log("初始化编辑面板");

                // 5. 备份原始配置（用于取消时回显）
                originalConfig = {
                    url: node.url,
                    method: node.method,
                    name: node.name,
                    upload: node.upload,
                    skipBodyParsing: node.skipBodyParsing
                };

                // 6. 初始化组件值为当前节点配置
                const zbHttpInComponent = document.getElementById("zb-http-in");
                zbHttpInComponent.value = originalConfig;

                // 7. 绑定变化事件（注意：每次打开弹窗重新绑定，避免重复绑定）
                zbHttpInComponent.removeEventListener('change', onChange); // 先移除旧监听
                zbHttpInComponent.addEventListener('change', onChange);
            }
        });

    })();
</script>